<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TeleScript Mobile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --tg-blue: #517da2; --tg-bg: #8ab4d0; --msg-sent: #effdde; --msg-received: #ffffff; }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        
        body { background-color: var(--tg-bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Pantalla de Inicio - Forzada para que se vea */
        #login-overlay { 
            position: fixed; inset: 0; background: #517da2; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 1000; color: white; padding: 20px;
        }
        .login-box { text-align: center; width: 100%; max-width: 300px; }
        .login-box input { width: 100%; padding: 15px; border-radius: 10px; border: none; margin: 20px 0; font-size: 16px; }
        .login-box button { width: 100%; padding: 15px; border-radius: 25px; border: none; background: #24A1DE; color: white; font-weight: bold; cursor: pointer; }

        /* Contenedor Principal */
        #app-container { display: none; flex-direction: column; height: 100vh; width: 100%; max-width: 500px; margin: 0 auto; background: #e6eff5; position: relative; }

        header { background: #517da2; color: white; padding: 12px 15px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .avatar-circle { width: 40px; height: 40px; background: #ef7e32; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }

        /* Burbujas de chat optimizadas */
        .msg-row { display: flex; width: 100%; margin-bottom: 5px; }
        .msg-row.me { justify-content: flex-end; }
        .message { max-width: 80%; padding: 8px 12px; border-radius: 15px; position: relative; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); line-height: 1.4; }
        .message.received { background: white; border-bottom-left-radius: 5px; }
        .message.sent { background: #effdde; border-bottom-right-radius: 5px; }
        .user-label { font-size: 11px; font-weight: bold; margin-bottom: 3px; display: block; }
        .img-msg { width: 100%; border-radius: 10px; margin-top: 5px; display: block; }

        /* Barra inferior para móvil */
        footer { background: white; padding: 10px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #ddd; }
        .input-area { flex: 1; background: #f4f4f5; border-radius: 20px; padding: 5px 15px; display: flex; align-items: center; }
        input[type="text"] { border: none; background: transparent; flex: 1; outline: none; padding: 8px; font-size: 16px; }
        .btn-icon { color: #517da2; font-size: 20px; cursor: pointer; border: none; background: none; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <i class="fab fa-telegram-plane" style="font-size: 60px;"></i>
            <h1 style="margin-top:10px;">TeleScript</h1>
            <input type="text" id="username-input" placeholder="¿Cómo te llamas?">
            <button onclick="saveUsername()">ENTRAR AL CHAT</button>
        </div>
    </div>

    <div id="app-container">
        <header>
            <div class="avatar-circle" id="my-avatar">?</div>
            <div style="flex:1">
                <h4 id="display-name" style="margin:0">Cargando...</h4>
                <small>en línea</small>
            </div>
            <i class="fas fa-sign-out-alt" onclick="logout()" style="cursor:pointer"></i>
        </header>

        <div id="chat-container"></div>

        <footer>
            <label for="file-input" class="btn-icon">
                <i class="fas fa-camera"></i>
            </label>
            <input type="file" id="file-input" accept="image/*" style="display:none" onchange="sendImage(this)">
            
            <div class="input-area">
                <input type="text" id="msg-input" placeholder="Escribe un mensaje..." onkeypress="if(event.key==='Enter') sendText()">
            </div>
            
            <button class="btn-icon" onclick="sendText()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </footer>
    </div>

    <script>
        // --- COLOCA TU URL AQUÍ ---
        const API_URL = "https://script.google.com/macros/s/AKfycbxDpRglsXz9hY6irITNqje8bDoYJoFDlL7z57x51VA9uNMX4PxspuhNViG2q8kyhBeq/exec"; 

        let myUser = localStorage.getItem('chat_user');

        window.onload = () => {
            if (myUser) {
                showApp();
            }
        };

        function saveUsername() {
            const val = document.getElementById('username-input').value.trim();
            if (val) {
                localStorage.setItem('chat_user', val);
                myUser = val;
                showApp();
            }
        }

        function showApp() {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            document.getElementById('display-name').innerText = myUser;
            document.getElementById('my-avatar').innerText = myUser[0].toUpperCase();
            loadMessages();
            setInterval(loadMessages, 4000);
        }

        function logout() {
            localStorage.removeItem('chat_user');
            location.reload();
        }

        async function loadMessages() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                const container = document.getElementById('chat-container');
                
                container.innerHTML = data.map(m => {
                    const isMe = m[1] === myUser;
                    return `
                        <div class="msg-row ${isMe ? 'me' : ''}">
                            <div class="message ${isMe ? 'sent' : 'received'}">
                                <span class="user-label" style="color:${isMe ? '#24A1DE' : '#673ab7'}">${m[1]}</span>
                                ${m[3] === 'image' ? `<img src="${m[2]}" class="img-msg">` : `<div>${m[2]}</div>`}
                            </div>
                        </div>
                    `;
                }).join('');
                container.scrollTop = container.scrollHeight;
            } catch (e) { console.error("Error cargando mensajes"); }
        }

        async function sendText() {
            const input = document.getElementById('msg-input');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = "";
            await postData({ user: myUser, message: msg, type: "text" });
        }

        function sendImage(input) {
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result.split(',')[1];
                await postData({ 
                    user: myUser, 
                    type: "image", 
                    fileName: input.files[0].name, 
                    mimeType: input.files[0].type, 
                    base64: base64 
                });
            };
            reader.readAsDataURL(input.files[0]);
        }

        async function postData(data) {
            try {
                // Usamos no-cors para evitar bloqueos en el envío de fotos
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(data)
                });
                setTimeout(loadMessages, 1000);
            } catch (e) { console.error("Error al enviar"); }
        }
    </script>
</body>
</html>