<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TeleScript History Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --blue: #517da2; --bg: #8ab4d0; --sent: #effdde; --received: #ffffff; }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        html, body { height: 100%; width: 100%; overflow: hidden; position: fixed; font-family: -apple-system, system-ui, sans-serif; }
        body { background: var(--bg); display: flex; justify-content: center; }

        #app { width: 100%; max-width: 500px; background: #e6eff5; display: flex; flex-direction: column; height: 100%; }

        header { background: var(--blue); color: white; padding: 10px 15px; display: flex; align-items: center; gap: 10px; flex-shrink: 0; z-index: 10; }
        .avatar { width: 35px; height: 35px; background: #ef7e32; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }

        #chat { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); 
            background-size: contain; -webkit-overflow-scrolling: touch; 
        }

        /* SEPARADOR DE FECHA */
        .date-separator {
            text-align: center; margin: 15px 0; position: sticky; top: 0; z-index: 5;
        }
        .date-badge {
            background: rgba(0,0,0,0.3); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;
        }

        .msg-row { display: flex; width: 100%; flex-direction: column; }
        .me { align-items: flex-end; }
        .others { align-items: flex-start; }

        .bubble { 
            max-width: 85%; padding: 6px 10px 15px 10px; border-radius: 15px; font-size: 15px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.2); word-wrap: break-word; position: relative; min-width: 80px;
        }
        .received .bubble { background: var(--received); border-bottom-left-radius: 4px; color: black; }
        .me .bubble { background: var(--sent); border-bottom-right-radius: 4px; color: black; }
        
        .user-name { font-size: 11px; font-weight: bold; margin-bottom: 3px; display: block; }
        .time { font-size: 10px; color: #888; position: absolute; bottom: 3px; right: 10px; }

        #emoji-bar { display: flex; overflow-x: auto; background: white; padding: 8px; gap: 15px; border-top: 1px solid #ddd; flex-shrink: 0; }
        #emoji-bar::-webkit-scrollbar { display: none; }
        .emoji { font-size: 22px; cursor: pointer; flex-shrink: 0; }

        footer { 
            background: white; padding: 10px; display: flex; align-items: center; gap: 10px; 
            flex-shrink: 0; border-top: 1px solid #ccc;
            padding-bottom: max(10px, env(safe-area-inset-bottom)); 
        }
        .input-box { flex: 1; background: #f0f0f0; border-radius: 20px; padding: 0 12px; display: flex; border: 1px solid #ddd; }
        input[type="text"] { border: none; background: transparent; flex: 1; outline: none; padding: 10px 0; font-size: 16px; color: black; }

        #viewer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; }
        #viewer img { max-width: 95%; max-height: 90%; border-radius: 5px; }

        #login { position: fixed; inset: 0; background: var(--blue); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #login input { padding: 15px; border-radius: 10px; border: none; width: 80%; max-width: 300px; margin-bottom: 20px; font-size: 16px; color: black; }
    </style>
</head>
<body>

    <div id="login">
        <i class="fab fa-telegram-plane" style="font-size: 60px;"></i>
        <h1 style="margin: 15px">TeleScript</h1>
        <input type="text" id="u-in" placeholder="¬øTu nombre?">
        <button onclick="doLogin()" style="padding: 15px 40px; border-radius: 25px; border: none; background: #24A1DE; color: white; font-weight: bold;">ENTRAR</button>
    </div>

    <div id="app" style="display:none">
        <header>
            <div id="av" class="avatar">?</div>
            <div style="flex:1"><b>TeleScript Chat</b><br><small id="status">en l√≠nea</small></div>
            <i class="fas fa-sign-out-alt" onclick="localStorage.clear(); location.reload()"></i>
        </header>

        <div id="chat"></div>

        <div id="emoji-bar"></div>

        <footer>
            <label for="f-in" style="color:var(--blue); font-size: 22px; cursor:pointer"><i class="fas fa-camera"></i></label>
            <input type="file" id="f-in" accept="image/*" style="display:none" onchange="sendImg(this)">
            <div class="input-box">
                <input type="text" id="m-in" placeholder="Mensaje..." autocomplete="off">
            </div>
            <button onclick="sendTxt()" style="color:var(--blue); border:none; background:none; font-size: 22px;"><i class="fas fa-paper-plane"></i></button>
        </footer>
    </div>

    <div id="viewer" onclick="this.style.display='none'"><img id="v-img"></div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxDpRglsXz9hY6irITNqje8bDoYJoFDlL7z57x51VA9uNMX4PxspuhNViG2q8kyhBeq/exec"; 
        const EMOJIS = ["üòä","üòÇ","üòç","üî•","üëç","‚ù§Ô∏è","üôå","üéâ","ü§î","üò±","üòé","üëÄ","‚ú®","üçï","üò≠","üò°","‚úÖ"];
        
        let myUser = localStorage.getItem('chat_user');
        let lastCount = 0;

        if(myUser) init();

        function doLogin() {
            const val = document.getElementById('u-in').value.trim();
            if(val) { localStorage.setItem('chat_user', val); myUser = val; init(); }
        }

        function init() {
            document.getElementById('login').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('av').innerText = myUser[0].toUpperCase();
            
            const eb = document.getElementById('emoji-bar');
            EMOJIS.forEach(e => {
                const s = document.createElement('span');
                s.className = 'emoji'; s.innerText = e;
                s.onclick = () => { const i = document.getElementById('m-in'); i.value += e; i.focus(); };
                eb.appendChild(s);
            });

            document.getElementById('m-in').addEventListener('focus', () => {
                setTimeout(() => { const c = document.getElementById('chat'); c.scrollTop = c.scrollHeight; }, 300);
            });

            load();
            setInterval(load, 4000);
        }

        async function load() {
            try {
                const r = await fetch(API_URL);
                const data = await r.json();
                if(data.length === lastCount) return;

                const chat = document.getElementById('chat');
                let html = "";
                let ultimaFecha = "";

                data.forEach(m => {
                    const isMe = m[1] === myUser;
                    const fechaObj = new Date(m[0]);
                    
                    // Formato para el separador: "21 de febrero"
                    const fechaDia = fechaObj.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
                    // Formato para la burbuja: "00:15"
                    const horaTexto = fechaObj.getHours() + ":" + String(fechaObj.getMinutes()).padStart(2, '0');

                    // Si cambia el d√≠a, ponemos el separador
                    if (fechaDia !== ultimaFecha) {
                        html += `<div class="date-separator"><span class="date-badge">${fechaDia}</span></div>`;
                        ultimaFecha = fechaDia;
                    }

                    html += `
                        <div class="msg-row ${isMe ? 'me' : 'others'} ${isMe ? 'sent' : 'received'}">
                            <div class="bubble">
                                <span class="user-name" style="color:${isMe ? '#24A1DE' : '#673ab7'}">${m[1]}</span>
                                ${m[3] === 'image' ? `<img src="${m[2]}" style="width:100%; border-radius:10px; margin-top:5px" onclick="view(this.src)">` : `<div>${m[2]}</div>`}
                                <span class="time">${horaTexto}</span>
                            </div>
                        </div>
                    `;
                });
                
                chat.innerHTML = html;
                lastCount = data.length;
                chat.scrollTop = chat.scrollHeight;
            } catch(e) {}
        }

        function view(src) { document.getElementById('v-img').src = src; document.getElementById('viewer').style.display = 'flex'; }

        async function sendTxt() {
            const i = document.getElementById('m-in');
            const t = i.value.trim();
            if(!t) return;
            i.value = ""; i.focus();
            await post({ user: myUser, message: t, type: "text" });
        }

        function sendImg(input) {
            if(!input.files[0]) return;
            document.getElementById('status').innerText = "Enviando...";
            const r = new FileReader();
            r.onload = async (e) => {
                const b64 = e.target.result.split(',')[1];
                await post({ user: myUser, type: "image", fileName: input.files[0].name, mimeType: input.files[0].type, base64: b64 });
                document.getElementById('status').innerText = "en l√≠nea";
            };
            r.readAsDataURL(input.files[0]);
        }

        async function post(data) {
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            setTimeout(load, 1500);
        }
    </script>
</body>
</html>